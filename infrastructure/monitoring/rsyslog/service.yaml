apiVersion: v1
kind: Service
metadata:
  name: rsyslog
  namespace: monitoring
  labels:
    app: rsyslog
    component: logging
spec:
  type: ClusterIP
  selector:
    app: rsyslog
  ports:
    # UDP port for legacy syslog
    - name: syslog-udp
      protocol: UDP
      port: 514
      targetPort: 514
    # TCP port for syslog
    - name: syslog-tcp
      protocol: TCP
      port: 514
      targetPort: 514
    # Prometheus metrics
    - name: metrics
      protocol: TCP
      port: 9144
      targetPort: 9144

---
apiVersion: v1
kind: Service
metadata:
  name: rsyslog-nodeport
  namespace: monitoring
  labels:
    app: rsyslog
    component: logging
  annotations:
    description: "NodePort service for rsyslog - enables external logging clients"
spec:
  type: NodePort
  selector:
    app: rsyslog
  ports:
    # UDP port for legacy syslog
    - name: syslog-udp
      protocol: UDP
      port: 514
      targetPort: 514
      nodePort: 30514
    # TCP port for syslog
    - name: syslog-tcp
      protocol: TCP
      port: 514
      targetPort: 514
      nodePort: 31514

---
apiVersion: v1
kind: Service
metadata:
  name: rsyslog-loadbalancer
  namespace: monitoring
  labels:
    app: rsyslog
    component: logging
  annotations:
    description: "LoadBalancer service for rsyslog - for external logging clients"
spec:
  type: LoadBalancer
  selector:
    app: rsyslog
  ports:
    # UDP port for legacy syslog
    - name: syslog-udp
      protocol: UDP
      port: 514
      targetPort: 514
    # TCP port for syslog
    - name: syslog-tcp
      protocol: TCP
      port: 514
      targetPort: 514
    # Metrics endpoint (internal only via ClusterIP)
  # Uncomment for production with real load balancer
  # externalIPs:
  #   - "your-external-ip"
  # loadBalancerSourceRanges:
  #   - "0.0.0.0/0"  # Restrict this in production

---
# ServiceMonitor for Prometheus scraping of rsyslog metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rsyslog
  namespace: monitoring
  labels:
    app: rsyslog
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: rsyslog
  endpoints:
    - port: metrics
      interval: 30s
      scrapeTimeout: 10s
      path: /metrics
